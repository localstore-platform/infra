# Docker Image Build and Push
# Builds and pushes Docker images for API and AI services

name: Docker Build

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (api/ai/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - api
          - ai
          - all
      api_tag:
        description: 'API git tag or "latest" for main branch'
        required: false
        default: 'latest'
      ai_tag:
        description: 'AI git tag or "latest" for main branch'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: localstore-platform

jobs:
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.service == 'api' || github.event.inputs.service == 'all' }}
    
    steps:
      - name: Checkout API Repository
        uses: actions/checkout@v4
        with:
          repository: localstore-platform/api
          ref: ${{ github.event.inputs.api_tag == 'latest' && 'main' || format('refs/tags/{0}', github.event.inputs.api_tag) }}
          path: api
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: api
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/api:${{ github.event.inputs.api_tag }}
          target: production
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-ai:
    name: Build AI Image
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.service == 'ai' || github.event.inputs.service == 'all' }}
    
    steps:
      - name: Checkout AI Repository
        uses: actions/checkout@v4
        with:
          repository: localstore-platform/ai-service
          ref: ${{ github.event.inputs.ai_tag == 'latest' && 'main' || format('refs/tags/{0}', github.event.inputs.ai_tag) }}
          path: ai-service
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push AI Image
        uses: docker/build-push-action@v5
        with:
          context: ai-service
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ai:${{ github.event.inputs.ai_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
